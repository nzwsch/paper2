---
title: "Writebook"
date: 2024-07-01T00:37:24+09:00
description: ""
tags:
- tag
---

37signalsにOnceというサイトがあるのだが、そこで[Writebook](https://once.com/writebook)というアプリケーションがフリーで配布されていた。

![Writebook](/images/writebook-01.webp)

MRSK(Kamal)が公開されたあたりで、AWSからVPSのようなデプロイへ徐々に移行しているようだ。
私も普段はオンプレミスなのでこういった兆候は好ましい。

詳しくはOnceのページを参照してほしいのだが、Onceの理念は興味深いものである。
その中で特筆すべきはインストールスクリプト経由であのCampfireのソースコードを取得することができるのだ。

通常有償のRailsのソースコード一式をわざわざ購入したいとは思わないが、いわばDHHやBasecampのソースコードを見られるめったにない機会である。
ただ残念なことに1ドル160円の円安時代にで6万円もするので正直なかなか手が出しにくい価格ではある。

いずれCampfireは購入してみたいとは思うのだが、ありがたいことに件のWritebookがなんと無償で公開されたので願ってもないことだった。
Docker経由で配布されるのでソースコードを取得しようと思っていたが、ZIPファイルも配布されているのでありがたい。

そこで今回はいくつか興味深いと思った箇所を残してみようと思う。

## puma-dev

まず興味深いのは[puma-dev](https://github.com/puma/puma-dev)というプロジェクトだ。

ずいぶん昔にPowというプロジェクトがあったが、Linuxに移行してからこの手の開発ツールはずっと使っていなかった。
いつかのタイミングでpuma-devという存在も知っていたが、なかなか試そうとは思うことがなかった。

`bin/setup`に用意されているのだが、開発環境で`https://writebook.test`にアクセスすれば自動的にサーバーが起動するようだ。
`.test`のドメインまでは設定できたが、残念ながらサーバーが反応しないので確認はできなかった。

一度設定できてしまえばOmakubのようなスクリプトを用意して今後は自動化したいと思っている。

## Procfile

次に興味深いのは`Procfile`だ。

Foremanか、あるいはOvermindかはわからないが`bin/dev`ではないようだ。
私はよく`docker-compose`コマンドで各種サーバーを起動するのだが、直接`redis-server`コマンドを起動している。

開発環境におけるアプローチとしてはDockerで極力ローカルにサーバーをインストールしないのがよいと思っていたが、`puma-dev`を使うのであれば常時サーバー起動している方が都合がよいのかもしれない。

いずれにしても`docker-compose.yml`ファイルに依存しない開発手法もあるのだと思うと目から鱗だった。

## app/assets/stylesheets

Writebookは素のCSSのみで書かれているようだ。

興味深いと思ったのはこれらのCSSをどうやってまとめているのかというところだったが、通常Railsでは`application.css`がデフォルトで存在しておりそこでSprocketsがファイルを変換する。
はずなのだが、Writebookにはそもそも`application.css`が存在しない。

```erb
<%= stylesheet_link_tag :all, "data-turbo-track": "reload" %>
```

代わりに`:all`を指定することですべてのCSSのリンクが自動的に生成されるようだ。
なるほどこれまでであれば単一のファイルにコンパイルする分CSSのファイルサイズは大きくなるが、ファイルごとにリクエストは増えるものの各ファイルを細かくして差分を抑えようとしているのかもしれない。
JavaScriptのファイルもImportmapを使っているので生成されたHTMLのソースファイルを見てみるとわかりやすいかもしれない。

## app/models/first_run.rb

Writebookはseedファイルの代わりに、初回インストール時に`FirstRun.create!`を実行する。

これは純粋なRubyのクラスで、いわゆるServiceクラスのような使われ方だ。

Railsではあまりこういったパターンを見かけないので、その実装を知れただけでも非常に勉強になった。

## app/models/

もともとDHHや37signalsではいわゆるServiceクラスやFormオブジェクトなどを使うよりも、Concernを使ってモデル側にクラスを`extend`することで機能を追加しようという[投稿](https://dev.37signals.com/vanilla-rails-is-plenty/)を目にしていた。

この記事でもサンプルコードはあるのだが、もっと具体的なディレクトリ構造を見てみたかった。
例えば`Account::Joinable`や、`Leaf::Editable`などの命名規則があってConcernは *-able* が接尾語として用いられているが、`Authorization`や`User::Role`といった単語が用いられているのも興味深い。
必ずしも *-able* で終わる必要はないというのはなかなか興味深いものであった。[^1]

[^1]: 私が以前携わったプロジェクトでは必ず *-able* の命名を守っていたし、私もそれが普通だと思っていた。

## app/controllers/concerns/

続いてコントローラーはどうだろうか。

モデルも非常に見やすいコードだが、コントローラー側もほとんどのメソッドが5行以内で非常に見やすい。

そして普段なかなかコントローラーのConcernを見る機会はないが、`include`することで自動で`set_`系のメソッドが実行できるようになるようだ。


## test、routes.rb

今回は興味深い箇所はテストだろうか。
RSpecはおろか、FactoryBotすら使っていないのは非常に興味深いものがある。

また`routes.rb`の書き方も地味に興味深い。
基本的な書き方がResourceベースなのに加えて、`direct`や`route_for`などといったなかなか見慣れない構文も発見できる。

## まとめ

あらためてRailsは非常に洗練されているフレームワークだなと再認識できた。

他にもまだまだ興味深い箇所はあるが、さすがに全てのコードを追うのも、全てを書くのも難しいので今回はこのあたりにしておこうと思う。
TurboやStimulusのコードは時間をかけて調べていきたい。

ゆくゆくはこういった整然としたコードをメンテナンスしていきたいが、そのためにも今後もRuby on Railsについてまだまだ知識を深めていく必要がある。
